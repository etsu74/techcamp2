# **開発ログ: Phase-1A-2 会議イベント構造化表示実装**

## **開発段階情報**
- **段階**: Phase-1A-2（会議イベント・依存関係機能）
- **実装日**: 2025-08-21
- **優先機能**: 会議イベント構造化表示（最重要キー機能）
- **開発者**: Claude Code + ユーザー
- **Git ブランチ**: `feature/phase1a-meeting-structure`

---

## **🎯 実装目標・重要性**

### **この機能が開発全体のキーである理由**
1. **マンション管理の核心機能**: 
   - 総会・理事会・修繕委員会の3層組織構造はマンション運営の根幹
   - 意思決定プロセスの可視化が本アプリの最大価値

2. **技術的基盤機能**:
   - 階層データ表示の技術実装が後続機能（編集・レポート等）の基礎
   - 複雑なデータ構造処理の実装パターン確立

3. **ユーザビリティ向上**:
   - 会議体系の理解促進 → 修繕計画の意思決定支援
   - 権限・報告関係の明確化 → 業務効率向上

### **実装目標**
- ✅ **組織階層表示**: 3レベル（総会・理事会・修繕委員会）の視覚的区分
- ✅ **色分け表示**: レベル別色分け（深紅・オレンジ・緑）
- ✅ **権限可視化**: 決定権限（final/executive/advisory）の表示
- ✅ **構造化UI**: 左パネル階層表示 + ガントチャート統合表示

---

## **📊 データ構造分析**

### **既存データ構造（`meeting_events_mock.csv`）**
```csv
organization_level,organization_type,decision_authority,report_to,timeline_color
1,general_meeting,final,,#8B0000        # 総会: 最終決定権
2,board_meeting,executive,GM1,#FF8C00     # 理事会: 執行権  
3,repair_committee,advisory,BM1,#32CD32   # 修繕委員会: 諮問権
```

### **組織階層構造**
```
Level 1: 総会（General Meeting）
├─ 権限: final（最終決定）
├─ 色: #8B0000（深紅）
├─ 頻度: annual（年1-2回）
└─ 決定事項: 予算承認、大規模修繕決定、理事選任

Level 2: 理事会（Board Meeting）  
├─ 権限: executive（執行）
├─ 色: #FF8C00（オレンジ）
├─ 頻度: monthly（月1回）
├─ 報告先: 総会
└─ 決定事項: 運営方針、中規模修繕、委員会監督

Level 3: 修繕委員会（Repair Committee）
├─ 権限: advisory（諮問）  
├─ 色: #32CD32（緑）
├─ 頻度: monthly + adhoc
├─ 報告先: 理事会
└─ 決定事項: 工事詳細、業者選定推薦
```

---

## **🛠️ 段階別実装手順**

### **Phase 1: CSS階層表示スタイル実装**

#### **ファイル**: `css/gantt.css`
```css
/* ====================================================
   会議イベント構造化表示スタイル - Phase-1A-2実装
   ==================================================== */

/* 組織階層別バースタイル */
.gantt .bar.level-1 {
    fill: #8B0000 !important;    /* 総会: 深紅 */
    stroke: #660000;
    stroke-width: 2px;
    opacity: 0.9;
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
}

.gantt .bar.level-2 {
    fill: #FF8C00 !important;    /* 理事会: オレンジ */
    stroke: #CC6600;
    stroke-width: 2px;
    opacity: 0.85;
    filter: drop-shadow(1px 1px 3px rgba(0,0,0,0.2));
}

.gantt .bar.level-3 {
    fill: #32CD32 !important;    /* 修繕委員会: 緑 */
    stroke: #228B22;
    stroke-width: 2px;
    opacity: 0.8;
    filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.1));
}

/* 組織レベル別アイコン表示 */
.gantt .bar.level-1::before {
    content: "📋";
    position: absolute;
    left: -20px;
    font-size: 14px;
}

.gantt .bar.level-2::before {
    content: "👥";
    position: absolute;
    left: -20px;
    font-size: 14px;
}

.gantt .bar.level-3::before {
    content: "🔧";
    position: absolute;
    left: -20px;
    font-size: 14px;
}

/* 権限別境界線スタイル */
.gantt .bar[data-authority="final"] {
    border: 3px solid #8B0000;
    border-radius: 6px;
}

.gantt .bar[data-authority="executive"] {
    border: 2px solid #FF8C00;
    border-radius: 4px;
}

.gantt .bar[data-authority="advisory"] {
    border: 1px dashed #32CD32;
    border-radius: 3px;
}
```

#### **左パネル階層表示CSS**
```css
/* 左パネル組織階層表示 */
.organization-group {
    border-left: 4px solid;
    margin: 8px 0;
    padding: 10px 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.organization-group.level-1 {
    border-color: #8B0000;
    background: linear-gradient(90deg, rgba(139, 0, 0, 0.1), rgba(139, 0, 0, 0.05));
}

.organization-group.level-2 {
    border-color: #FF8C00;
    background: linear-gradient(90deg, rgba(255, 140, 0, 0.1), rgba(255, 140, 0, 0.05));
    margin-left: 15px;
}

.organization-group.level-3 {
    border-color: #32CD32;
    background: linear-gradient(90deg, rgba(50, 205, 50, 0.1), rgba(50, 205, 50, 0.05));
    margin-left: 30px;
}

.group-header {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.group-header .authority-badge {
    background: rgba(0,0,0,0.1);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: normal;
}

.event-item.meeting-item {
    padding: 6px 10px;
    margin: 4px 0;
    border-radius: 4px;
    background: rgba(255,255,255,0.7);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.event-authority {
    font-size: 10px;
    background: rgba(0,0,0,0.2);
    padding: 1px 6px;
    border-radius: 8px;
    color: #666;
}
```

### **Phase 2: JavaScript階層処理機能実装**

#### **ファイル**: `js/gantt-manager.js` - 機能追加
```javascript
/**
 * 会議イベント構造化表示処理（Phase-1A-2 キー機能）
 * @param {Array} meetingData 会議イベントデータ配列
 * @returns {Object} 組織レベル別に構造化されたデータ
 */
structureMeetingEvents: function(meetingData) {
    console.log('Phase-1A-2: 会議イベント構造化処理開始');
    
    // 組織レベル別にグループ化
    const structuredData = {
        level1: [], // 総会（General Meeting）
        level2: [], // 理事会（Board Meeting）
        level3: []  // 修繕委員会（Repair Committee）
    };
    
    meetingData.forEach(meeting => {
        const level = parseInt(meeting.organization_level || 2);
        const levelKey = `level${level}`;
        
        if (structuredData[levelKey]) {
            structuredData[levelKey].push(this.formatMeetingForHierarchy(meeting));
        } else {
            console.warn(`未知の組織レベル: ${level}`, meeting);
        }
    });
    
    // 各レベルの統計情報出力
    Object.keys(structuredData).forEach(levelKey => {
        const count = structuredData[levelKey].length;
        console.log(`${levelKey}: ${count}件の会議イベント`);
    });
    
    return structuredData;
},

/**
 * 階層表示用会議イベントフォーマット
 * @param {Object} meeting 会議イベント生データ
 * @returns {Object} 階層表示対応フォーマット
 */
formatMeetingForHierarchy: function(meeting) {
    const level = parseInt(meeting.organization_level || 2);
    const authorityMap = {
        'final': '最終決定',
        'executive': '執行権',
        'advisory': '諮問権'
    };
    
    return {
        ...this.formatMeetingEvent(meeting),
        organization_level: level,
        decision_authority: meeting.decision_authority,
        decision_authority_jp: authorityMap[meeting.decision_authority] || '不明',
        report_to: meeting.report_to,
        custom_class: `meeting level-${level}`,
        hierarchy_info: {
            level: level,
            authority: meeting.decision_authority,
            parent: meeting.report_to,
            color: meeting.timeline_color || this.getDefaultColor(level)
        }
    };
},

/**
 * 組織レベル別デフォルト色取得
 */
getDefaultColor: function(level) {
    const colorMap = {
        1: '#8B0000',  // 総会: 深紅
        2: '#FF8C00',  // 理事会: オレンジ
        3: '#32CD32'   // 修繕委員会: 緑
    };
    return colorMap[level] || '#666666';
},

/**
 * 階層関係可視化データ生成
 */
generateHierarchyConnections: function(structuredData) {
    const connections = [];
    
    // Level 1 → Level 2 関係
    structuredData.level1.forEach(meeting1 => {
        structuredData.level2.forEach(meeting2 => {
            if (meeting2.report_to === meeting1.id) {
                connections.push({
                    from: meeting1.id,
                    to: meeting2.id,
                    type: 'hierarchy',
                    relationship: 'reports_to'
                });
            }
        });
    });
    
    // Level 2 → Level 3 関係  
    structuredData.level2.forEach(meeting2 => {
        structuredData.level3.forEach(meeting3 => {
            if (meeting3.report_to === meeting2.id) {
                connections.push({
                    from: meeting2.id,
                    to: meeting3.id,
                    type: 'hierarchy',
                    relationship: 'reports_to'
                });
            }
        });
    });
    
    console.log(`階層関係: ${connections.length}件の関係性を検出`);
    return connections;
}
```

### **Phase 3: 左パネル階層表示機能実装**

#### **ファイル**: `js/main.js` - 関数追加
```javascript
/**
 * 左パネル階層表示更新（Phase-1A-2 キー機能）
 * @param {Object} structuredMeetings 構造化済み会議データ
 * @param {Array} workTasks 工事タスクデータ
 */
function updateLeftPanelWithHierarchy(structuredMeetings, workTasks) {
    console.log('Phase-1A-2: 左パネル階層表示更新開始');
    
    const eventList = document.getElementById('event-list');
    eventList.innerHTML = '';
    
    // 階層順序で表示（上位から下位へ）
    const hierarchyOrder = [
        { key: 'level1', name: '総会（最高意思決定機関）', icon: '📋', authority: '最終決定権' },
        { key: 'level2', name: '理事会（月次運営機関）', icon: '👥', authority: '執行権' },
        { key: 'level3', name: '修繕委員会（実行機関）', icon: '🔧', authority: '諮問権' }
    ];
    
    hierarchyOrder.forEach(levelInfo => {
        const meetings = structuredMeetings[levelInfo.key];
        if (meetings && meetings.length > 0) {
            const groupElement = createHierarchyGroup(levelInfo, meetings);
            eventList.appendChild(groupElement);
        }
    });
    
    // 工事イベントグループを追加
    if (workTasks && workTasks.length > 0) {
        const workGroup = createWorkTasksGroup(workTasks);
        eventList.appendChild(workGroup);
    }
    
    console.log('左パネル階層表示更新完了');
}

/**
 * 階層グループ要素作成
 * @param {Object} levelInfo レベル情報
 * @param {Array} meetings 会議データ配列
 * @returns {HTMLElement} グループ要素
 */
function createHierarchyGroup(levelInfo, meetings) {
    const level = levelInfo.key.replace('level', '');
    
    const groupDiv = document.createElement('div');
    groupDiv.className = `organization-group level-${level}`;
    groupDiv.setAttribute('data-level', level);
    
    // グループヘッダー作成
    const header = document.createElement('div');
    header.className = 'group-header';
    header.innerHTML = `
        <div>
            <span class="org-icon">${levelInfo.icon}</span>
            <strong>${levelInfo.name}</strong>
            <span class="meeting-count">(${meetings.length}件)</span>
        </div>
        <span class="authority-badge">${levelInfo.authority}</span>
    `;
    groupDiv.appendChild(header);
    
    // 会議イベント一覧作成
    meetings.forEach((meeting, index) => {
        const eventItem = document.createElement('div');
        eventItem.className = `event-item meeting-item level-${level}`;
        eventItem.setAttribute('data-meeting-id', meeting.id);
        eventItem.innerHTML = `
            <div class="event-main">
                <span class="event-name">${meeting.name}</span>
                <span class="event-date">${meeting.start}</span>
            </div>
            <div class="event-meta">
                <span class="event-authority">[${meeting.decision_authority_jp}]</span>
                <span class="event-frequency">${meeting.frequency}</span>
            </div>
        `;
        
        // クリックイベント追加
        eventItem.addEventListener('click', () => highlightMeetingInGantt(meeting.id));
        
        groupDiv.appendChild(eventItem);
    });
    
    return groupDiv;
}

/**
 * 工事タスクグループ作成
 */
function createWorkTasksGroup(workTasks) {
    const groupDiv = document.createElement('div');
    groupDiv.className = 'organization-group work-tasks';
    groupDiv.innerHTML = `
        <div class="group-header">
            <div>
                <span class="org-icon">🏗️</span>
                <strong>修繕工事タスク</strong>
                <span class="meeting-count">(${workTasks.length}件)</span>
            </div>
        </div>
    `;
    
    workTasks.forEach(task => {
        const eventItem = document.createElement('div');
        eventItem.className = 'event-item work-item';
        eventItem.innerHTML = `
            <span class="event-name">${task.name}</span>
            <span class="event-progress">${task.progress}%</span>
        `;
        groupDiv.appendChild(eventItem);
    });
    
    return groupDiv;
}

/**
 * ガントチャート内の会議をハイライト
 */
function highlightMeetingInGantt(meetingId) {
    // 既存のハイライトをクリア
    document.querySelectorAll('.gantt .bar.highlighted').forEach(bar => {
        bar.classList.remove('highlighted');
    });
    
    // 該当会議をハイライト
    const targetBar = document.querySelector(`.gantt .bar[data-id="${meetingId}"]`);
    if (targetBar) {
        targetBar.classList.add('highlighted');
        targetBar.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}
```

### **Phase 4: メイン制御統合処理**

#### **ファイル**: `js/main.js` - `renderGanttChart`関数更新
```javascript
/**
 * ガントチャート描画（Phase-1A-2 統合版）
 */
function renderGanttChart(data) {
    console.log('Phase-1A-2: 統合ガントチャート描画開始');
    
    try {
        // データ分離：会議イベントと工事イベント
        const meetingEvents = data.filter(item => 
            item.organization_level || 
            item.organization_type ||
            GanttManager.isMeetingEvent(item)
        );
        const workEvents = data.filter(item => 
            !item.organization_level && 
            !item.organization_type &&
            !GanttManager.isMeetingEvent(item)
        );
        
        console.log(`会議イベント: ${meetingEvents.length}件`);
        console.log(`工事イベント: ${workEvents.length}件`);
        
        // 会議イベント構造化（Phase-1A-2 キー処理）
        const structuredMeetings = GanttManager.structureMeetingEvents(meetingEvents);
        
        // 階層関係生成
        const hierarchyConnections = GanttManager.generateHierarchyConnections(structuredMeetings);
        
        // 左パネル階層表示更新（Phase-1A-2 キー機能）
        updateLeftPanelWithHierarchy(structuredMeetings, workEvents);
        
        // ガントチャート用データ統合
        const combinedData = [
            ...Object.values(structuredMeetings).flat(),
            ...workEvents
        ];
        
        // カスタムクラス適用
        combinedData.forEach(item => {
            if (item.organization_level) {
                item.custom_class = `${item.custom_class || ''} level-${item.organization_level}`.trim();
            }
        });
        
        console.log(`統合データ: ${combinedData.length}件`);
        
        // Frappe Gantt描画・更新
        if (ganttChart) {
            ganttChart.refresh(combinedData);
        } else {
            ganttChart = new Gantt('#gantt', combinedData, {
                view_mode: currentViewMode,
                date_format: 'YYYY-MM-DD',
                popup_trigger: 'click',
                view_modes: ['Day', 'Week', 'Month', 'Year'],
                bar_height: 20,
                bar_corner_radius: 3,
                arrow_curve: 5,
                padding: 18,
                custom_popup_html: function(task) {
                    return generateCustomPopup(task, hierarchyConnections);
                }
            });
        }
        
        // CSS適用後の後処理
        setTimeout(() => {
            applyHierarchyStyles();
            updateDataCount(combinedData.length);
        }, 100);
        
        console.log('Phase-1A-2: 統合ガントチャート描画完了');
        
    } catch (error) {
        ErrorHandler.handleError('Phase-1A-2統合ガントチャート描画エラー', error);
    }
}

/**
 * 階層スタイル後適用
 */
function applyHierarchyStyles() {
    document.querySelectorAll('.gantt .bar').forEach(bar => {
        const taskId = bar.getAttribute('data-id');
        const task = projectData.find(t => t.id === taskId);
        
        if (task && task.organization_level) {
            bar.classList.add(`level-${task.organization_level}`);
            bar.setAttribute('data-authority', task.decision_authority || 'unknown');
        }
    });
}

/**
 * カスタムポップアップ生成
 */
function generateCustomPopup(task, connections) {
    let popupHtml = `<div class="popup-title">${task.name}</div>`;
    popupHtml += `<div class="popup-content">`;
    popupHtml += `<p><strong>期間:</strong> ${task.start} 〜 ${task.end}</p>`;
    
    if (task.organization_level) {
        const levelNames = { 1: '総会', 2: '理事会', 3: '修繕委員会' };
        popupHtml += `<p><strong>組織:</strong> ${levelNames[task.organization_level]}</p>`;
        popupHtml += `<p><strong>権限:</strong> ${task.decision_authority_jp || task.decision_authority}</p>`;
        
        if (task.report_to) {
            popupHtml += `<p><strong>報告先:</strong> ${task.report_to}</p>`;
        }
        
        if (task.frequency) {
            const freqNames = { annual: '年次', monthly: '月次', adhoc: '臨時' };
            popupHtml += `<p><strong>頻度:</strong> ${freqNames[task.frequency] || task.frequency}</p>`;
        }
    } else {
        popupHtml += `<p><strong>進捗:</strong> ${task.progress}%</p>`;
    }
    
    popupHtml += `</div>`;
    return popupHtml;
}
```

---

## **🧪 テスト・検証手順**

### **テスト段階1: データ読み込み確認**
1. `meeting_events_mock.csv`ファイルの読み込み
2. 組織レベル別データ分類確認
3. コンソールログでの統計情報確認

### **テスト段階2: 表示確認**
1. 左パネル階層表示の視覚確認
2. ガントチャート色分け確認  
3. アイコン・権限表示確認

### **テスト段階3: インタラクション確認**
1. 左パネル会議クリック → ガントハイライト
2. 表示モード切替での階層表示維持
3. カスタムポップアップ表示内容確認

---

## **📝 実装チェックリスト**

### **CSS実装**
- [ ] `css/gantt.css`に組織レベル別スタイル追加
- [ ] 左パネル階層表示CSS追加
- [ ] 権限別境界線スタイル追加
- [ ] レスポンシブ対応確認

### **JavaScript実装**  
- [ ] `js/gantt-manager.js`に構造化処理関数追加
- [ ] `js/main.js`に左パネル階層表示機能追加
- [ ] `renderGanttChart`関数の統合処理更新
- [ ] エラーハンドリング実装

### **テスト・検証**
- [ ] `meeting_events_mock.csv`での動作確認
- [ ] 3レベル階層表示確認
- [ ] 色分け・アイコン表示確認
- [ ] インタラクション動作確認
- [ ] 表示モード切替での動作確認

---

## **🚀 次のステップ**

### **Phase-1A-2完了後の展開**
1. **依存関係矢印表示**: Frappe Ganttバージョン問題解決後に実装
2. **Phase-1A-3**: 統合テスト・パフォーマンス最適化
3. **Phase-1B**: 編集機能・レポート出力機能

### **拡張機能候補**
- 会議議事録連携機能
- 権限別アクセス制御
- 会議スケジュール自動提案機能

---

## **💾 Gitコミット予定**

### **コミットメッセージ**
```
feat: Phase-1A-2完了 - 会議イベント構造化表示実装

- 組織階層表示（総会・理事会・修繕委員会）
- レベル別色分け・権限表示機能
- 左パネル階層UI・ガントチャート統合表示
- 階層関係可視化・カスタムポップアップ
- meeting_events_mock.csvテストデータ対応

🎯 This is the KEY FEATURE for the entire project
```

### **タグ付け予定**
- `v0.2.0-phase1a2`: Phase-1A-2完了マイルストーン

---

このPhase-1A-2の会議イベント構造化表示実装により、マンション修繕計画アプリの核心機能が完成し、後続開発の技術基盤が確立される。