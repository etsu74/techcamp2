# 開発ログ: 起動時ブランク画面バグ修正

**作業日時**: 2025-08-28  
**作業者**: Claude Code + User  
**ブランチ**: main  
**コミット**: `610655f` - "fix: 起動時ブランク画面バグ修正 - setupScrollSynchronization nullポインタエラー解決"

---

## 📋 **問題発生状況**

### **報告された問題**
- **症状**: 起動時に画面がブランク表示になる
- **想定動作**: unified_format_sample.csv画面を表示して起動
- **実際の状況**: 表示されなくなった

### **エラーログ分析**
```
main.js:1179 Uncaught TypeError: Cannot read properties of null (reading 'parentElement')
    at setupScrollSynchronization (main.js:1179:48)
    at HTMLDocument.<anonymous> (main.js:25:5)
```

**根本原因**: `ganttContainer.querySelector('svg').parentElement` でSVG要素がnullの場合のエラー処理不備

---

## 🔍 **問題分析プロセス**

### **1. 初期状況確認**
- サーバー起動: `python3 -m http.server 8080` (正常)
- ブラウザコンソール確認: TypeError発生確認
- main.js:1179行目特定: setupScrollSynchronization関数内エラー

### **2. 技術的原因特定**
```javascript
// 問題のあったコード (main.js:1179)
ganttContainer.querySelector('svg').parentElement,

// 問題: SVG要素がまだ存在しない状態でparentElementにアクセス
// → querySelector('svg')がnullを返すとnull.parentElementでエラー
```

### **3. 初期化順序問題の発見**
```javascript
// main.js:25 - 初期化時にスクロール同期を実行
setupScrollSynchronization(); 

// 問題: この時点ではガントチャートがまだ描画されていない
// → SVG要素が存在しない状態でアクセスしようとしてエラー
```

---

## 🛠️ **修正実装内容**

### **修正1: null安全な要素取得**
```javascript
// 修正前 (エラー発生)
ganttContainer.querySelector('svg').parentElement,

// 修正後 (null安全)
const svgElement = ganttContainer.querySelector('svg');
const svgParent = svgElement ? svgElement.parentElement : null;

const candidates = [
    document.querySelector('.gantt-container'),
    document.querySelector('.right-panel'),
    svgParent, // null安全な値を使用
    ganttContainer,
    document.documentElement,
    document.body
];
```

### **修正2: 初期化タイミング調整**
```javascript
// 修正前 - DOMContentLoaded時に即座実行
document.addEventListener('DOMContentLoaded', function() {
    // ...
    setupScrollSynchronization(); // ← 早すぎる実行
});

// 修正後 - ガントチャート描画後に実行
function renderGanttChart() {
    // ... ガントチャート描画処理
    
    // スクロール同期機能を再初期化（チャート描画後）
    setTimeout(() => {
        setupScrollSynchronization();
    }, 100);
}
```

### **修正3: デモデータ自動読み込み復旧**
```javascript
// loadSampleData()がコメントアウトされていたため復旧
// loadSampleData(); ← コメント状態

// 修正: loadDemoData()で自動読み込み復活
loadDemoData(); // unified_format_sample.csv自動読み込み
```

---

## ✅ **修正結果確認**

### **動作確認項目**
- [x] 起動時エラーなし
- [x] デモデータ自動表示
- [x] ガントチャート正常描画
- [x] 会議◆マーク表示
- [x] 依存関係矢印表示
- [x] スクロール同期機能動作

### **コンソールログ確認**
```
マンション修繕計画ガントチャート - 初期化開始
イベントリスナー設定完了
(エラーログなし)
デモデータ読み込み完了: 62件
ガントチャート描画完了
スクロール同期初期化完了
```

---

## 🎯 **技術的学習ポイント**

### **1. null安全プログラミング**
- DOM要素取得時の存在確認の重要性
- `element?.method` または `element ? element.method : null` パターン
- 早期return や例外処理による安全な実装

### **2. 初期化順序設計**
- DOM構築 → ライブラリ初期化 → カスタム機能追加の順序遵守
- 非同期処理でのタイミング制御（setTimeout活用）
- 依存関係のある処理の適切な順序付け

### **3. デバッグプロセス**
- エラーメッセージから問題箇所の特定
- スタックトレースによる実行順序の把握
- ブラウザ開発者ツールの効果的活用

---

## 📊 **修正前後比較**

| 項目 | 修正前 | 修正後 |
|------|---------|---------|
| 起動状態 | ブランク画面 | 正常表示 |
| エラーログ | TypeError発生 | エラーなし |
| デモデータ | 表示されない | 自動表示 |
| 初期化順序 | 不適切 | 適切 |
| null安全性 | なし | 実装済み |

---

## 🔄 **今後の改善方針**

### **防止策**
1. **初期化順序チェックリスト作成**
   - DOM → ライブラリ → カスタム機能の順序確認
   
2. **null安全コーディング規約**
   - DOM要素取得時の必須存在確認
   - エラーハンドリングの標準化

3. **動作確認自動化**
   - 起動時エラーチェックの自動化
   - 主要機能の動作確認スクリプト

### **コード品質向上**
- エラーハンドリング強化
- ログレベル管理（開発/本番環境対応）
- ユニットテスト追加検討

---

## 📋 **作業サマリー**

**作業時間**: 約30分  
**修正ファイル数**: 5ファイル  
**修正規模**: 中程度（null安全処理追加、初期化順序調整）  
**テスト状況**: 手動テスト完了、全機能正常動作確認  
**品質レベル**: 本番運用レベル復旧

### **技術的成果**
- ✅ 致命的バグの迅速解決
- ✅ null安全プログラミング技術習得  
- ✅ 初期化順序設計の理解深化
- ✅ デバッグスキルの向上

**修正完了日時**: 2025-08-28  
**動作確認**: 完了 ✅  
**本番適用**: 準備完了 ✅